<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Provider Dashboard</title>
	<link rel="stylesheet" href="../css/main.css">
	<link rel="stylesheet" href="../css/components.css">
	<link rel="stylesheet" href="../css/pages.css">
	<style>
		.dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
		.card { background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); padding: 20px; }
		.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
		.form-row + .form-row { margin-top: 12px; }
		.form-row input, .form-row select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; }
		button.primary { background: #39b54a; color: white; border: none; border-radius: 10px; padding: 10px 16px; cursor: pointer; }
		.products { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
		.item { background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); padding: 12px; }
		.titulo-item { display: block; font-weight: 600; margin-bottom: 8px; }
		.img-item { width: 100%; height: 140px; object-fit: cover; border-radius: 10px; }
		.precio-item { display: block; margin: 8px 0; font-weight: 600; color: #2ecc71; }
	</style>
</head>
<body>
	<app-header></app-header>
	<section class="container" style="padding: 40px 20px;">
		<h1 style="margin-bottom: 10px;">Panel de Proveedor</h1>
		<p>Gestiona tus productos y añade nuevos ítems al marketplace.</p>
		<div class="dashboard-grid" style="margin-top: 20px;">
			<div class="card">
				<h3>Añadir producto</h3>
				<form id="product-form">
					<div class="form-row">
						<input type="text" id="p-name" placeholder="Nombre" required>
						<input type="number" step="0.01" id="p-price" placeholder="Precio" required>
					</div>
					<div class="form-row">
						<input type="url" id="p-image" placeholder="URL de imagen" required>
						<select id="p-category">
							<option value="fast-food">Fast Food</option>
							<option value="bakery">Bakery</option>
							<option value="pizza">Pizza</option>
							<option value="sushi">Sushi</option>
							<option value="chicken">Chicken</option>
							<option value="local" selected>Local</option>
						</select>
					</div>
					<div class="form-row" style="grid-template-columns: 1fr;">
						<textarea id="p-desc" placeholder="Descripción" rows="3"></textarea>
					</div>
					<div style="margin-top: 12px;">
						<button class="primary" type="submit">Guardar</button>
					</div>
				</form>
			</div>
			<div class="card">
				<h3>Mis productos</h3>
				<div id="provider-products" class="products"></div>
			</div>
		</div>
	</section>
	<app-footer></app-footer>

	<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
	<script src="../firebase/firebase-config.js"></script>
	<script src="../auth/firebase-auth.js"></script>
	<script src="../js/roles.js"></script>
	<script>
		RolesHelper.requireRole(['provider']);

		const form = document.getElementById('product-form');
		const list = document.getElementById('provider-products');

		function renderItem(p) {
			const el = document.createElement('div');
			el.className = 'item';
			el.dataset.productId = p.id;
			el.innerHTML = `
				<span class="titulo-item">${p.title}</span>
				<img class="img-item" src="${p.image}" alt="${p.title}">
				<span class="precio-item">$${Number(p.price).toFixed(2)}</span>
			`;
			return el;
		}

		async function loadProviderProducts() {
			try {
				const uid = firebaseServices.auth.currentUser?.uid;
				if (!uid) return;
				const snap = await firebaseServices.db.collection('products').where('providerId','==',uid).orderBy('createdAt','desc').get();
				list.innerHTML = '';
				snap.forEach(doc => {
					list.appendChild(renderItem(doc.data()));
				});
			} catch (e) { console.warn(e); }
		}

		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			try {
				const user = firebaseServices.auth.currentUser;
				if (!user) return;
				const data = {
					title: document.getElementById('p-name').value.trim(),
					price: parseFloat(document.getElementById('p-price').value || '0') || 0,
					image: document.getElementById('p-image').value.trim(),
					description: document.getElementById('p-desc').value.trim(),
					category: document.getElementById('p-category').value,
				};
				const saved = await window.firebaseAuthService.createProduct(user.uid, data);
				list.prepend(renderItem(saved));
				form.reset();
				alert('Producto guardado');
			} catch (e) {
				alert('Error: ' + (e?.message || e));
			}
		});

		loadProviderProducts();
	</script>
</body>
</html>


